define(["jquery","geoloc/domReady","t5/core/ajax"],function($,domReady,ajax){MapContainer.defaults={};function MapContainer(element,items,nbreTotalResultat,defaults,smarttag){this.initialize(element,items,nbreTotalResultat,defaults,smarttag)}MapContainer.prototype={map:null,markers:[],clusterGroup:null,popin:null,items:null,defaults:null,smarttag:null,element:null,nbreTotalResultat:0,initialize:function(element,items,nbreTotalResultat,defaults,smarttag){this.element=element;this.items=items;this.defaults=
defaults;this.smarttag=smarttag;this.nbreTotalResultat=nbreTotalResultat},createMap:function(){var mapOptions;var mapCanvasID=this.element[0].id;var body=$("body");var southWest=new L.LatLng(75,-180),northEast=new L.LatLng(-75,180),bounds=new L.LatLngBounds(southWest,northEast),center=[46.498392,2.60376];this.map=new L.Mappy.Map(mapCanvasID,{clientId:"poleemploi",center:center,zoom:2,minZoom:1,scrollWheelZoom:true,zoomControl:{position:"topleft"},layersControl:false,logoControl:{position:"bottomright",
dir:this.defaults.logo.substring(0,this.defaults.logo.length-13)},maxBounds:bounds,tileLayer:{continuousWorld:false,noWrap:true}});if(this.items!=null&&this.items.length>0)this.initMarkers(this.items);else this.map.setZoomAround(center,5)},initMarkers:function(){var self=this;if(self.clusterGroup!==null)self.clusterGroup.clearLayers();self.markers=[];var body=$("body");self.clusterGroup=L.markerClusterGroup({zoomToBoundsOnClick:false});var limitTo=self.items.length>150?150:self.items.length;for(var i=
0;i<limitTo;i++){var item=self.items[i];var libelle=self.defaults.libelleLien;var order=self.defaults.order;self.markers[i]=L.marker(item.coordonnees,{icon:this.getAwesomeMarker("darkblue"),bounceOnAdd:false,riseOffset:500,riseOnHover:true,visited:false});var desc=this.getDescription(item,order);var icons=this.getIconGroup(item,order);var tooltip_hd,tooltip_bd,tooltip_ft;tooltip_hd='\x3cdiv class\x3d"tooltip-hd"\x3e\x3cp class\x3d"title"\x3e\x3ca data-event\x3d"'+self.defaults.eventALancer+'" data-context\x3d"'+
item.content.id+'" id\x3d"mapPagelink_'+i+'" href\x3d"'+self.defaults.baseHrefPourDetail+item.content.id+'"\x3e'+item.content.title+'\x3c/a\x3e\x3cspan class\x3d"subtitle"\x3e'+item.content.subtitle+"\x3c/span\x3e\x3c/p\x3e\x3c/div\x3e";tooltip_bd='\x3cdiv class\x3d"tooltip-bd"\x3e\x3cdiv class\x3d"row"\x3e\x3cdiv class\x3d"col-xs-6"\x3e'+desc+'\x3c/div\x3e\x3cdiv class\x3d"col-xs-6"\x3e'+'\x3cdl class\x3d"icon-group"\x3e'+icons+"\x3c/dl\x3e"+"\x3c/div\x3e\x3c/div\x3e\x3c/div\x3e";if(self.smarttag!=
null)tooltip_ft='\x3cdiv class\x3d"tooltip-ft"\x3e\x3cp\x3e\x3ca data-event\x3d"'+self.defaults.eventALancer+'" data-context\x3d"'+item.content.id+'" id\x3d"mapPagelink_'+i+'" class\x3d"btn btn-primary btn-sm" role\x3d"button" href\x3d"'+self.defaults.baseHrefPourDetail+item.content.id+'" onClick\x3d"'+self.smarttag+'"\x3e'+libelle+"\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e";else tooltip_ft='\x3cdiv class\x3d"tooltip-ft"\x3e\x3cp\x3e\x3ca data-event\x3d"'+self.defaults.eventALancer+'" data-context\x3d"'+item.content.id+
'" id\x3d"mapPagelink_'+i+'" class\x3d"btn btn-primary btn-sm" role\x3d"button" href\x3d"'+self.defaults.baseHrefPourDetail+item.content.id+'"\x3e'+libelle+"\x3c/a\x3e\x3c/p\x3e\x3c/div\x3e";var popup=L.popup().setContent(tooltip_hd+tooltip_bd+tooltip_ft);self.markers[i].bindPopup(popup);self.markers[i].on("click",function(e){this.options.visited=true;this.setIcon(self.getAwesomeMarker("darkpurple"))});$(".leaflet-popup .btn-primary").on("click",function(e){$("body").addClass("modal-details-open")});
$(document).on("click","#mapPagelink_"+i,function(event){if(event.which!==2){var _this=$(this);event.preventDefault();history.pushState("detail","Page dÃ©tail",_this.attr("href"));_this.trigger(_this.data("event"),_this.data("context"));var elementLien=_this.parents(".result");elementLien.addClass("active");$("#PopinDetails").on("hidden.bs.modal",function(){history.back();$(this).off("hidden.bs.modal");elementLien.removeClass("active").addClass("seen");$("body").removeClass("modal-details-open")})}});
self.clusterGroup.addLayer(self.markers[i])}if(limitTo>0){self.clusterGroup.on("clusterclick",function(a){a.layer.spiderfy()});self.map.addLayer(self.clusterGroup);self.map.fitBounds(self.clusterGroup.getBounds(),{maxZoom:15})}},getDescription:function(item,order){var description,subdescription;if(!item.content.description)description="";else description='\x3cp class\x3d"description"\x3e'+item.content.description+"\x3c/p\x3e";if(!item.content.subdescription)subdescription="";else subdescription='\x3cp class\x3d"subdescription"\x3e'+
item.content.subdescription+"\x3c/p\x3e";return order.descriptionFirst?description+subdescription:subdescription+description},address:function(item){return'\x3cdt\x3e\x3cspan class\x3d"icon-pinmap-location" aria-hidden\x3d"true" title\x3d"Lieu de la formation"\x3e\x3c/span\x3e\x3cspan class\x3d"sr-only"\x3eLieu de la formation\x3c/span\x3e\x3c/dt\x3e\x3cdd\x3e'+item.content.address+"\x3c/dd\x3e"},typeFormation:function(item){return'\x3cdt\x3e\x3cspan class\x3d"icon-formation" aria-hidden\x3d"true" title\x3d"Type de formation"\x3e\x3c/span\x3e\x3cspan class\x3d"sr-only"\x3eType de formation\x3c/span\x3e\x3c/dt\x3e\x3cdd\x3e'+
item.content.typeFormation+"\x3c/dd\x3e"},certifiante:function(item){return item.content.certifiante?'\x3cdt\x3e\x3cspan class\x3d"icon-experience" aria-hidden\x3d"true" title\x3d"Certification"\x3e\x3c/span\x3e\x3cspan class\x3d"sr-only"\x3eLa formation est-elle certifiante ?\x3c/span\x3e\x3c/dt\x3e\x3cdd\x3eCertifiante\x3c/dd\x3e':""},typeContrat:function(item){return'\x3cdt\x3e\x3cspan class\x3d"icon-malette-poste" aria-hidden\x3d"true" title\x3d"Type de contrat"\x3e\x3c/span\x3e\x3cspan class\x3d"sr-only"\x3eType de contrat\x3c/span\x3e\x3c/dt\x3e\x3cdd\x3e'+
item.content.contract+"\x3c/dd\x3e"},getIconGroup:function(item,order){var content="";for(var key in order.iconelements)switch(order.iconelements[key]){case "address":content+=this.address(item);break;case "typeFormation":content+=this.typeFormation(item);break;case "certifiante":content+=this.certifiante(item);break;case "typeContrat":content+=this.typeContrat(item);break;default:}return content},refresh:function(){this.map.invalidateSize(true)},getAwesomeMarker:function(color){var awesomeMarker=
L.AwesomeMarkers.icon({markerColor:color,icon:"circle",prefix:"fa",spin:true,shadowSize:[0,0]});return awesomeMarker},keyboardAction:function(e){var self=this;if(e.keyCode==27)self.minimizePopin()}};return MapContainer});